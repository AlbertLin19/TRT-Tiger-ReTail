<!DOCTYPE html>
<html>

<head>
    <title>TRT Tiger ReTail</title>
    {% load static %}
    <link rel="icon" href="{% static 'marketplace/favicon.ico' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'marketplace/styles.css' %}">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/3270b6ed53.js" crossorigin="anonymous"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script type="text/javascript" src="{% static 'marketplace/functions.js' %}"></script>

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: rgb(245, 174, 81);">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'gallery' %}"> <img src="{% static 'marketplace/logo.png' %}" width="40"> <strong> Tiger ReTail</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-collapse collapse" id="navbarNavAltMarkup">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'gallery' %}">Home</a>
                    </li>
                    {% if account %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'inbox' %}">Inbox<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'account_activity' %}">Activity Log<span
                            class="sr-only">(current)</span></a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'faq' %}">FAQ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contact' %}">Contact Us</a>
                    </li>

                    {% if account %}
                    
                    {% endif %}
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if account %}
                    <li class="nav-item dropdown" id="notifications_dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button"
                            id="notifications_button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="far fa-bell mx-1"></i>
                        </a>
                        <ul class="dropdown-menu p-0 m-0" aria-labelledby="notifications_button">
                            <div class="container-fluid overflow-auto" style="max-height: 30vh;"
                                id="notifications_area"></div>
                            <hr class="m-1 mt-2">
                            <a class="dropdown-item mb-1" href="{% url 'list_notifications' %}">All
                                Notifications</a>
                        </ul>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button"
                            id="account_button" data-bs-toggle="dropdown" aria-expanded="false">
                            My Account
                        </a>
                        <ul class="dropdown-menu p-0 m-0 pt-1" aria-labelledby="account_button">
                            <a class="dropdown-item mb-1" href="{% url 'list_items' %}">My Items</a>
                            <a class="dropdown-item mb-1" href="{% url 'list_item_requests' %}">My Requests</a>
                            <a class="dropdown-item mb-1" href="{% url 'list_purchases' %}">My Purchases</a>
                            <a class="dropdown-item mb-1" href="{% url 'edit_account' %}">Settings</a>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'logout' %}">Logout</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'edit_account' %}">Login<span
                                class="sr-only">(current)</span></a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div>
        {% include 'marketplace/message.html' %}
        <script>
            $(document).ready(function () {
                $('.toast').toast('show');
            });
        </script>
    </div>

    {% if account %}
    <!-- script for notifications menu -->
    <script>
        'use strict';

        const notifications = []; // will store in order starting from most recent
        // each notification is ["pk", "datetime", "text", "seen", "url"]
        let beg_notification_pk = -1;
        let end_notification_pk = -1;
        
        // generates and injects notifications html from notifications array
        function injectNotificationsHTML() {
            let html = '';
            for (const notification of notifications) {
                const date = new Date(notification[1]);
                html += '<hr class="m-0">';
                html += '<a class="orange-link" href="' + notification[4] + '">';
                html += '<div class="mx-0 my-1 p-2" style="text-align:left;';
                if (!notification[3])
                    html += ' background-color: #fff0db;';
                html += '">';
                html += '<small>';
                html += notification[2];
                html += '<br>';
                html += '<small class="text-secondary">' + date.toLocaleString() + '</small>';
                html += '</small>';
                html += '</div>';
                html += '</a>';
            }
            $('#notifications_area').html(html);
        }

        function populateNotificationsHTMLSynchronously(count, period) {
            // if no notifications yet gotten, try retrieving just most recent one first
            if (beg_notification_pk === -1 && end_notification_pk === -1)
            {
                fetch("/notifications/get_relative/?count=1&direction=backward&base_notification_pk=-1")
                    .then((resp) => {return resp.json();})
                    .then((data) => {
                        if (data["notifications"].length === 0) {
                            window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                            return;
                        }
                        notifications.push(data["notifications"][0]);
                        injectNotificationsHTML();
                        end_notification_pk = data["notifications"][0][0];
                        beg_notification_pk = data["notifications"][0][0];
                        window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                        return;
                    })
                    .catch((error) => {
                        window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                        return console.log(error);
                    });
                return;
            }

            // get notifications backward
            fetch("/notifications/get_relative/?count=" + count + "&direction=backward&base_notification_pk=" + end_notification_pk)
                .then((resp) => {return resp.json();})
                .then((data) => {
                    if (data['notifications'].length != 0) {
                        notifications.push(...data['notifications']);
                        end_notification_pk = data['notifications'][data['notifications'].length - 1][0];
                    }
                    
                    // get notifications forward
                    fetch("/notifications/get_relative/?count=" + count + "&direction=forward&base_notification_pk=" + beg_notification_pk)
                        .then((resp) => {return resp.json();})
                        .then((data) => {
                            if (data['notifications'].length != 0) {
                                notifications.unshift(...(data['notifications'].reverse())); // need to add reversed and to the front of the notifications list
                                beg_notification_pk = data['notifications'][data['notifications'].length - 1][0];
                            }

                            injectNotificationsHTML();
                            window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                            return;
                        })
                        .catch((error) => {
                            window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                            return console.log(error);
                        });
                    return;
                })
                .catch((error) => {
                    window.setTimeout(() => {populateNotificationsHTMLSynchronously(count, period)}, period);
                    return console.log(error);
                });
            return;
        }

        function handleCount(response) {
            let html = '<i class="far fa-bell mx-1"></i>';
            const count = response['count'];
            if (count > 0) {
                html += '<span class="badge text-dark bg-light mx-1">';
                html += count;
                html += '</span>';
            }
            $('#notifications_button').html(html);
        }

        function getCount() {
            $.ajax(
                {
                    type: "GET",
                    url: "{% url 'count_notifications' %}",
                    success: handleCount,
                }
            );
        }

        // set notifications already retrieved to "seen"
        function seeNotifications() {
            let url = "/notifications/see/?notifications=";
            for (const notification of notifications) {
                url += notification[0] + ",";
            }
            fetch(url).catch((error) => {
                return console.log(error);
            });
        }

        function setup() {
            $("#notifications_dropdown").on("show.bs.dropdown", seeNotifications);
            window.setTimeout(() => {populateNotificationsHTMLSynchronously(15, 10)}, 0);
            window.setInterval(getCount, 1000);
        }

        $('document').ready(setup);

    </script>
    {% endif %}

    {% block content %}{% endblock content %}
    <script>
        $(function () {
            $('[data-bs-toggle="tooltip"]').tooltip()
        })

        $(function () {
            $('[data-bs-toggle="popover"]').popover()
        })
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
</body>

</html>